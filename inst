#!/usr/bin/env bash

# Nihon Installer v1.0.0

set -euo pipefail
IFS=$'\n\t'

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

CHECK="${GREEN}✔${NC}"
CROSS="${RED}✖${NC}"
INFO="${CYAN}➜${NC}"
WARN="${YELLOW}⚠${NC}"

# Update these URLs to point to your hosted files
DYLIB_URL="https://github.com/zeronildev/Nihon-mac/raw/af5bbd8791b43c26d0d77e4c69f12cc163d6c5e3/libNihon.dylib"  # libNihon.dylib
UI_URL="https://github.com/zeronildev/Nihon-mac/blob/945d7321aeb6d719f77383d37a94bd8fa4d0a7c0/nihon"     # Nihon.app (Tauri build)
 # If you have additional modules/patcher

if [ -w "/Applications" ]; then
    APP_DIR="/Applications"
    echo -e "${INFO} Installing Roblox to /Applications"
else
    APP_DIR="$HOME/Applications"
    mkdir -p "$APP_DIR"
    echo -e "${WARN} No write access to /Applications; using $APP_DIR instead."
fi

TEMP="$(mktemp -d)"

spinner() {
    local msg="$1"
    local pid="$2"
    local spin='⠋⠙⠹⠸⠼⠴⠦⠧⠇⠏'
    local i=0

    while kill -0 "$pid" 2>/dev/null; do
        printf "\r\033[K${CYAN}[${spin:i++%${#spin}:1}]${NC} %s" "$msg "
        sleep 0.1
    done

    wait "$pid"
    printf "\r\033[K"
    printf "${GREEN}${CHECK} %s - Completed${NC}\n" "$msg"
    return 0
}

banner() {
    clear
    echo -e "${BOLD}${CYAN}"
    cat <<'EOF'
    ███╗   ██╗██╗██╗  ██╗ ██████╗ ███╗   ██╗
    ████╗  ██║██║██║  ██║██╔═══██╗████╗  ██║
    ██╔██╗ ██║██║███████║██║   ██║██╔██╗ ██║
    ██║╚██╗██║██║██╔══██║██║   ██║██║╚██╗██║
    ██║ ╚████║██║██║  ██║╚██████╔╝██║ ╚████║
    ╚═╝  ╚═══╝╚═╝╚═╝  ╚═╝ ╚═════╝ ╚═╝  ╚═══╝
EOF
    echo -e "${NC}"
    echo -e "${BLUE}=[ Nihon Installer ]=${NC}"
    echo -e "${CYAN}Roblox Executor for macOS${NC}"
}

section() {
    echo
    echo -e "${BOLD}${CYAN}==> $1${NC}"
}

main() {
    banner

    # Kill any running instances
    killall -9 RobloxPlayer Nihon &>/dev/null || true
    
    # Clean up old installations
    rm -rf "$APP_DIR/Roblox.app" "$APP_DIR/nihon.app"
    rm -rf ~/Nihon/modules/latest.json ~/Nihon/modules/luau-lsp ~/Nihon/modules/Server

    section "Fetching client version"
    local version="version-cfe7460f53b444a5"  
    echo -e "${INFO} Version: ${BOLD}$version${NC}"

    section "Downloading Roblox - ($version)"
    (
        curl -fsSL "https://setup.rbxcdn.com/mac/$version-RobloxPlayer.zip" -o "$TEMP/RobloxPlayer.zip"
        unzip -oq "$TEMP/RobloxPlayer.zip" -d "$TEMP"
        mv "$TEMP/RobloxPlayer.app" "$APP_DIR/Roblox.app"
        xattr -cr "$APP_DIR/Roblox.app"
    ) & spinner "Downloading Roblox" $!

    section "Installing Nihon modules"
    (
        # Download and install dylib
        curl -fsSL "$DYLIB_URL" -o "$TEMP/libNihon.dylib"
        mv "$TEMP/libNihon.dylib" "$APP_DIR/Roblox.app/Contents/Resources/libNihon.dylib"
        
        # Patch the Roblox binary to load your dylib
        "$TEMP/Resources/Patcher" "$APP_DIR/Roblox.app/Contents/Resources/libNihon.dylib" "$APP_DIR/Roblox.app/Contents/MacOS/libmimalloc.3.dylib" --strip-codesig --all-yes >/dev/null 2>&1
        mv "$APP_DIR/Roblox.app/Contents/MacOS/libmimalloc.3.dylib_patched" "$APP_DIR/Roblox.app/Contents/MacOS/libmimalloc.3.dylib"

        # Download and install UI
        curl -fsSL "$UI_URL" -o "$TEMP/NihonUI.zip"
        unzip -oq "$TEMP/NihonUI.zip" -d "$TEMP"

        # Create necessary directories
        mkdir -p ~/Nihon/workspace ~/Nihon/autoexec ~/Nihon/themes ~/Nihon/modules ~/Nihon/modules/Server ~/Nihon/modules/luau-lsp
        
        # Move server and LSP if you have them
        [ -f "$TEMP/Resources/Server" ] && mv -f "$TEMP/Resources/Server" ~/Nihon/modules/Server/server
        [ -f "$TEMP/Resources/luau-lsp" ] && mv -f "$TEMP/Resources/luau-lsp" ~/Nihon/modules/luau-lsp/luau-lsp
        
        # Install UI app
        mv -f "$TEMP/nihon.app" "$APP_DIR/nihon.app"
    ) & spinner "Installing Nihon" $!

    section "Finishing installation"
    (
        codesign --force --deep --sign - "$APP_DIR/Roblox.app" >/dev/null 2>&1
        codesign --force --deep --sign - "$APP_DIR/Nihon.app" >/dev/null 2>&1
        rm -rf "$TEMP"
        rm -rf "$APP_DIR/Roblox.app/Contents/MacOS/RobloxPlayerInstaller.app" >/dev/null 2>&1
        tccutil reset Accessibility com.Roblox.RobloxPlayer >/dev/null 2>&1
    ) & spinner "Finishing" $!

    echo
    echo -e "${GREEN}${BOLD}Installation complete!${NC}"
    echo -e "${INFO} Nihon has been installed to $APP_DIR"
    echo -e "${WARN} Please use an alt account for safety."
    
    open "$APP_DIR/Roblox.app"
    open "$APP_DIR/nihon.app"
}

main
